layui.config({dir:"/static/extend/layui/",version:!1,debug:!0,base:"/static/extend/plugins/"}),layui.use(["element","layer","form","table","upload","laydate","carousel"],function(){const layer=layui.layer,form=layui.form,element=layui.element,table=layui.table,upload=layui.upload,laydate=layui.laydate,carousel=layui.carousel,E=window.wangEditor;let editor;Render_Table(),Render_Time(),Render_Upload(),Render_Viewer(),Render_Carousel(),FLAG.search_box&&$("[fiy-id=search-box]").slideToggle(),$(window).resize(function(){});const open_loop_anim=()=>{$("[fiy-loop]").find("i").addClass("layui-anim layui-anim-rotate layui-anim-loop")},close_loop_anim=()=>{$("[fiy-loop]").find("i").removeClass("layui-anim layui-anim-rotate layui-anim-loop")},Page_Reload=()=>{let url=location.pathname;$.pjax({url:url,container:"#pjax-container"})},Table_Reload=()=>{table.reload(DTB_ID),close_loop_anim()},PJAX_END=()=>{Change_This(),form.render(),element.render(),Render_Table(),Render_Time(),Render_Carousel(),close_loop_anim()},Set_Dtb_Status=ele=>{1==ele.attr("value")?(ele.removeAttr("checked"),ele.attr("value",0)):(ele.attr("checked"),ele.attr("value",1))},Get_Dtb_Item_Id=ele=>ele.attr("fiy-id"),Change_This=()=>{let thUrl=location.pathname;$("dd[fiy-side-tpl]").each((index,elem)=>{if($(elem).children("a").attr("href")==thUrl)return $("dd[fiy-side-tpl]").removeClass("layui-this"),$(elem).addClass("layui-this"),!1})},Request=(url,data="",type="get",req_type=1,ele="")=>{let load;$.ajax({url:url,type:type,data:data,dataType:"json",async:!0,beforeSend:function(){load=layer.load(2)},success:res=>{if(console.log(res),1==res.code)switch(layer.msg(res.msg,{icon:1,anim:1}),req_type){case 1:Page_Reload();break;case 2:Set_Dtb_Status(ele);break;case 3:ele.del();break;case 4:Table_Reload();break;case 5:layer.closeAll("page"),Table_Reload();break;default:Page_Reload()}else layer.msg(res.msg,{icon:2,anim:6})},error:function(e){console.log(e),layer.msg("请求失败!",{icon:2,anim:6})},complete:function(){layer.close(load)}})},modal=(url,title,content,area,data="",type="get",is_upload=0)=>{let load;area.indexOf(",")>-1&&(area=area.split(",")),""==content?$.ajax({url:url,type:type,data:data,beforeSend:function(){load=layer.load(2)},complete:function(){layer.close(load)},success:function(html){layer.open({type:1,title:title,skin:"fiy-layer",area:area,maxHeight:"90vh",content:html,maxmin:!0,shade:0,success:function(layero,index){form.render(),Render_Time(),element.render(),Render_Viewer(),0!=is_upload&&(Render_Upload(),Render_wangEditor()),form.on("submit(event_form)",function(data){console.log(data);let url=$(data.form).attr("fiy-url"),type=$(data.form).attr("method");if(console.log(data.field),console.log($(data.form).find(".editor").length),$(data.form).find(".editor").length>0){let ele=$(data.form).find(".editor").eq(0);data.field[ele.attr("name")]=editor.txt.html()}let formData={table:$(data.form).attr("fiy-table"),data:data.field};return console.log(formData),Request(url,formData,type,5,index),!1})},cancel:function(index1,layero){return layer.confirm("确定关闭么?",{icon:3,title:"关闭提示"},function(index2){layer.close(index1),layer.close(index2)}),!1}})}}):layer.open({title:title,area:area,content:content,btn:["确认"]})};function Get_Dtb_Table(){return $(`#${DTB_ID}`).attr("fiy-table")}function Render_Time(){laydate.render({elem:"#search_regtime",type:"datetime",range:"~"}),laydate.render({elem:"#search_uptime",type:"datetime",range:"~"}),laydate.render({elem:"#search_born",type:"date",range:"~"}),laydate.render({elem:"#add_regtime",type:"datetime",range:!1,value:new Date}),laydate.render({elem:"#add_uptime",type:"datetime",range:!1,value:new Date}),laydate.render({elem:"#edit_regtime",type:"datetime",range:!1}),laydate.render({elem:"#edit_uptime",type:"datetime",range:!1}),laydate.render({elem:"#add_born",type:"date",range:!1}),laydate.render({elem:"#edit_born",type:"date",range:!1}),laydate.render({elem:"#add_time",type:"datetime",range:!1}),laydate.render({elem:"#edit_time",type:"datetime",range:!1})}function Render_Table(where="",id="#"+DTB_ID){0==where.length&&(where={table:Get_Dtb_Table()});let ele=$(id);if(0==ele.length)return;let cols=[];ele.find("th").each(function(index,item){let th_=$(item).html();cols.push($.parseJSON(th_))}),table.render({elem:id,height:"auto",url:ele.attr("fiy-url"),page:!0,where:where,cols:[cols],even:!1,toolbar:"default",defaultToolbar:["filter","print","exports"],done:function(){close_loop_anim(),Render_Viewer()}})}function Render_Viewer(){$("[fiy-photo]").viewer({zIndex:"19951020",url:"src"})}function Render_Upload(){upload.render({elem:"[fiy-upload]",url:UPLOAD_URL,data:{table:Get_Dtb_Table()},field:"file",size:UPLOAD_MAXSIZE,accept:"file",exts:UPLOAD_EXT,multiple:!0,auto:!1,choose:function(obj){let th=this.item,type=parseInt(th.attr("fiy-upload-type"));obj.preview(function(index,file,result){let mime=file.type,img;console.log(mime),img=mime.indexOf("image")>-1?`<div class="img-box"><img src='${result}' fiy-photo /><span class='img-title' fiy-photo-id='${index}'></span></div>`:`<div class="img-box"><img src='/static/source/img/file.png' fiy-photo /><span class='img-title' fiy-photo-id='${index}'></span></div>`,1==type?th.nextAll("[fiy-photo-list]").html(img):2==type?th.nextAll("[fiy-photo-list]").append(img):3==type?th.nextAll("[fiy-photo-list]").html(img):4==type&&th.nextAll("[fiy-photo-list]").append(img),getFileMd5($(`[fiy-photo-id='${index}']`),file,res=>{console.log("md5:"+res),$.get(Check_File_Exist,{md5:res},function(res){if(console.log(res),0==res.code)obj.upload(index,file);else{layer.msg("上传成功");let input=th.prev().find("input");1==type?input.val(res.data.net_path):2==type?0==input.val().length?input.val(res.data.net_path):input.val(input.val()+";"+res.data.net_path):3==type?input.val(res.data.path):4==type&&(0==input.val().length?input.val(res.data.path):input.val(input.val()+";"+res.data.path)),Render_Viewer()}})})})},before:function(obj){layer.load()},allDone:function(obj){Render_Viewer()},done:function(res,index,upload){layer.closeAll("loading");let th=this.item,type=parseInt(th.attr("fiy-upload-type")),input=th.prev().find("input");layer.msg(res.msg),console.log(res),1==res.code&&(1==type?input.val(res.data.net_path):2==type?0==input.val().length?input.val(res.url):input.val(input.val()+";"+res.url):3==type?input.val(res.data.path):4==type&&(0==input.val().length?input.val(res.phy_url):input.val(input.val()+";"+res.phy_url)),Render_Viewer())},error:function(index,upload){layer.closeAll("loading")}})}function getFileMd5(ele,file,callback){var blobSlice=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,chunkSize=2097152,chunks=100,currentChunk=0,spark=new SparkMD5.ArrayBuffer,fileReader=new FileReader;function loadNext(){var start=currentChunk*chunkSize,end=start+chunkSize>=file.size?file.size:start+chunkSize;fileReader.readAsArrayBuffer(blobSlice.call(file,start,end))}fileReader.onload=(e=>{spark.append(e.target.result);let percent=(++currentChunk/100*100).toFixed(0)+"%";ele.text(percent),currentChunk<100?loadNext():(ele.fadeOut(500),callback(spark.end()))}),fileReader.onerror=function(){console.warn("oops, something went wrong.")},loadNext()}function getFileSha1(file,callback){var reader=new FileReader;reader.onload=(event=>{var res=event.target.result;res=CryptoJS.lib.WordArray.create(res);var sha1=CryptoJS.SHA1(res).toString();callback("3:"+sha1)}),reader.readAsArrayBuffer(file)}function getFileMd5_2(file,callback){var reader=new FileReader;reader.onload=(event=>{var res=event.target.result;res=CryptoJS.lib.WordArray.create(res);var sha1=CryptoJS.MD5(res).toString();callback("2:"+sha1)}),reader.readAsArrayBuffer(file)}function Render_wangEditor(){if($("body").find(".editor").length>0){let html="";"edit"==$(".editor").attr("fiy-event")&&(html=$(".editor").find(".content").html()),(editor=new E(".editor")).customConfig.debug=!0,editor.customConfig.uploadImgServer=UPLOAD_IMG_WANGEDITOR,editor.customConfig.uploadImgMaxSize=UPLOAD_MAXSIZE,editor.customConfig.uploadFileName="file[]",editor.customConfig.uploadImgParams={table:Get_Dtb_Table()},editor.create(),editor.txt.html(html)}}function Render_Carousel(ele=$("[fiy-id=carousel]")){layui.each(ele,function(index,elem){let th=$(elem),width=th.attr("fiy-width")||"100%",height=th.attr("fiy-height")||"140px",trigger=th.attr("fiy-tigger")||"hover",autoplay=th.attr("fiy-autoplay")||!1,arrow=th.attr("fiy-arrow")||"none";carousel.render({elem:th,width:width,arrow:arrow,autoplay:autoplay,trigger:trigger,height:height})})}function Render_Echarts(){echarts_file(),echarts_user_location(),echarts_test1(),echarts_test2(),echarts_test3(),echarts_test4()}function echarts_file(){var dom=document.getElementById("file_total");if(dom){var myChart,option={title:{text:"文件统计"},tooltip:{},legend:{data:["数量"]},xAxis:{data:["软件","压缩包","图片","视频","文档","其他"]},yAxis:{},series:[{name:"数量",type:"bar",data:[5,20,36,10,10,20]}]};echarts.init(dom).setOption(option)}}function echarts_user_location(){var dom=document.getElementById("user_location");if(dom){var myChart,option={title:{text:"南丁格尔玫瑰图",subtext:"纯属虚构",x:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{x:"center",y:"bottom",data:["rose1","rose2","rose3","rose4","rose5","rose6","rose7","rose8"]},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["pie","funnel"]},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,series:[{name:"面积模式",type:"pie",radius:[30,110],center:["50%","50%"],roseType:"area",data:[{value:10,name:"rose1"},{value:5,name:"rose2"},{value:15,name:"rose3"},{value:25,name:"rose4"},{value:20,name:"rose5"},{value:35,name:"rose6"},{value:30,name:"rose7"},{value:40,name:"rose8"}]}]};echarts.init(dom).setOption(option)}}function echarts_test1(){var dom=document.getElementById("echarts_test1");if(dom){var myChart,option={angleAxis:{},radiusAxis:{type:"category",data:["周一","周二","周三","周四"],z:10},polar:{},series:[{type:"bar",data:[1,2,3,4],coordinateSystem:"polar",name:"A",stack:"a"},{type:"bar",data:[2,4,6,8],coordinateSystem:"polar",name:"B",stack:"a"},{type:"bar",data:[1,2,3,4],coordinateSystem:"polar",name:"C",stack:"a"}],legend:{show:!0,data:["A","B","C"]}};echarts.init(dom).setOption(option)}}function echarts_test2(){var dom=document.getElementById("echarts_test2");if(dom){var myChart,option={title:{text:"基础雷达图"},tooltip:{},legend:{data:["预算分配（Allocated Budget）","实际开销（Actual Spending）"]},radar:{name:{textStyle:{color:"#fff",backgroundColor:"#999",borderRadius:3,padding:[3,5]}},indicator:[{name:"销售（sales）",max:6500},{name:"管理（Administration）",max:16e3},{name:"信息技术（Information Techology）",max:3e4},{name:"客服（Customer Support）",max:38e3},{name:"研发（Development）",max:52e3},{name:"市场（Marketing）",max:25e3}]},series:[{name:"预算 vs 开销（Budget vs spending）",type:"radar",data:[{value:[4300,1e4,28e3,35e3,5e4,19e3],name:"预算分配（Allocated Budget）"},{value:[5e3,14e3,28e3,31e3,42e3,21e3],name:"实际开销（Actual Spending）"}]}]};echarts.init(dom).setOption(option)}}function echarts_test3(){var dom=document.getElementById("echarts_test3");if(dom){var myChart=echarts.init(dom),axisData=["周一","周二","周三","很长很长的周四","周五","周六","周日"],data=axisData.map(function(item,i){return Math.round(1e3*Math.random()*(i+1))}),links=data.map(function(item,i){return{source:i,target:i+1}});links.pop();var option={title:{text:"笛卡尔坐标系上的 Graph"},tooltip:{},xAxis:{type:"category",boundaryGap:!1,data:axisData},yAxis:{type:"value"},series:[{type:"graph",layout:"none",coordinateSystem:"cartesian2d",symbolSize:40,label:{normal:{show:!0}},edgeSymbol:["circle","arrow"],edgeSymbolSize:[4,10],data:data,links:links,lineStyle:{normal:{color:"#2f4554"}}}]};myChart.setOption(option)}}function echarts_test4(){var dom=document.getElementById("echarts_test4");if(dom){var myChart,option={title:{text:"某站点用户访问来源",subtext:"纯属虚构",x:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",left:"left",data:["直接访问","邮件营销","联盟广告","视频广告","搜索引擎"]},series:[{name:"访问来源",type:"pie",radius:"55%",center:["50%","60%"],data:[{value:335,name:"直接访问"},{value:310,name:"邮件营销"},{value:234,name:"联盟广告"},{value:135,name:"视频广告"},{value:1548,name:"搜索引擎"}],itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};echarts.init(dom).setOption(option)}}form.on("submit(*)",function(data){let url=$(data.form).attr("fiy-url"),type=$(data.form).attr("method");return console.log(data.field),Request(url,data.field,type),!1}),form.on("submit(event_page_form)",function(data){let url=$(data.form).attr("fiy-url"),type=$(data.form).attr("method");console.log(data.field);let formData={table:$(data.form).attr("fiy-table"),data:data.field};return Request(url,formData,type),!1}),form.on("submit(form_search)",function(data){let arr={},blur=0,where;for(let item in data.field)"blur"!=item?data.field[item].length>0&&(arr[item]=data.field[item]):blur=data.field[item];if(0!=Object.keys(arr).length)return Render_Table({table:Get_Dtb_Table(),data:arr,blur:blur}),!1;layer.msg("请输入条件再搜索")}),form.on("switch(tpl_status_switch)",function(data){let url=DTB_STATUS,ele=$(data.elem),status=0==data.value?1:0;Request(url,{table:Get_Dtb_Table(),id:Get_Dtb_Item_Id(ele),status:status},"POST",2,ele)}),form.on("select(user_id)",function(data){let ele=$(data.elem);$(document).find("input[name=to]").val(ele.find("option:selected").attr("fiy-email"))}),table.on("rowDouble(dtb)",function(obj){console.log(obj.tr),console.log(obj.data),console.log("双击")}),table.on("toolbar(dtb)",function(obj){let checkStatus=table.checkStatus(obj.config.id),data={id:0,table:Get_Dtb_Table(),event:obj.event},th=$(`#${DTB_ID}`);switch(obj.event){case"add":modal(th.attr("fiy-event-url"),"添加","","800px,auto",data,"post",1);break;case"update":if(checkStatus.data.length>1)return void layer.msg("请仅选择一项");if(0==checkStatus.data.length)return void layer.msg("请选择一项进行操作");data.id=checkStatus.data[0].id,data.event="edit",modal(th.attr("fiy-event-url"),"编辑","","800px,auto",data,"post",1);break;case"delete":if(0==checkStatus.data.length)return void layer.msg("请至少选择一项进行操作");data.event="del",data.id=[],checkStatus.data.map(function(item,index){data.id.push(item.id)}),layer.confirm("真的删除这些项目么",{icon:3,title:"删除提示"},function(index){layer.close(index),Request(th.attr("fiy-event-url"),data,"post",4)})}}),table.on("tool(dtb)",function(obj){let layEvent=obj.event,th=$(this),data={id:th.parent().attr("fiy-id"),table:Get_Dtb_Table(),event:layEvent};"view"===layEvent?modal(th.parent().attr("fiy-url"),th.attr("fiy-title")||"信息",th.attr("fiy-content")||"",th.attr("fiy-area")||"800px,auto",data,"post"):"del"===layEvent?layer.confirm("真的删除此项么",{icon:3,title:"删除提示"},function(index){layer.close(index),Request(th.parent().attr("fiy-url"),data,"post",3,obj)}):"edit"===layEvent&&modal(th.parent().attr("fiy-url"),th.attr("fiy-title")||"信息",th.attr("fiy-content")||"",th.attr("fiy-area")||"800px,auto",data,"post",1)}),form.verify({username:function(value,item){return new RegExp("^[a-zA-Z0-9_一-龥\\s·]+$").test(value)?/(^\_)|(\__)|(\_+$)/.test(value)?"用户名首尾不能出现下划线'_'":/^\d+\d+\d$/.test(value)?"用户名不能全为数字":void 0:"用户名不能有特殊字符"},pass:[/^[\S]{5,20}$/,"密码必须5到20位，且不能出现空格"],pass2:function(value,item){if($(item).parents(".layui-form-item").prev().find("input[name=new]").val()!=value)return"两次密码不一致"}}),echarts_file(),echarts_user_location(),echarts_test1(),echarts_test2(),echarts_test3(),echarts_test4(),$(document).on("pjax:start",()=>{NProgress.start()}),$(document).on("pjax:end",()=>{PJAX_END(),Render_Echarts(),NProgress.done()}),$(document).pjax("a[data-pjax]","#pjax-container",{cache:!1}),$(document).on("click","a[fiy-logout]",function(){let th=$(this);layer.confirm("真的退了么?",{icon:3,title:"退出提示"},function(index){layer.close(index),Request(th.attr("fiy-link"))})}),$(document).on("click","a[fiy-shrink]",function(){let th=$(this),th_i=th.children("i"),flag;1==th.attr("fiy-flag")?(th_i.removeClass("layui-icon-shrink-right"),th_i.addClass("layui-icon-spread-left"),$(".layui-layout-admin .layui-side").addClass("layui-side2"),$(".layui-body").addClass("layui-body2"),$(".layui-footer").addClass("layui-footer2"),th.attr("fiy-flag",2)):(th_i.removeClass("layui-icon-spread-left"),th_i.addClass("layui-icon-shrink-right"),$(".layui-layout-admin .layui-side").removeClass("layui-side2"),$(".layui-body").removeClass("layui-body2"),$(".layui-footer").removeClass("layui-footer2"),th.attr("fiy-flag",1)),Render_Table()}),$(document).on("click","[fiy-modal]",function(){let th=$(this);modal(th.attr("fiy-modal")||"",th.attr("fiy-title")||"信息",th.attr("fiy-content")||"",th.attr("fiy-area")||"800px",th.attr("fiy-is-upload")||0)}),$(document).on("click","a[fiy-reload]",function(e){open_loop_anim(),Page_Reload()}),$(document).on("click","a[table_render]",function(){0!=$("#"+DTB_ID).length&&(open_loop_anim(),Render_Table())}),$(document).on("click","a[fiy-id=select-icon]",function(){let load;$.ajax({type:"get",url:ICON_URL,beforeSend:function(){load=layer.load(2)},complete:function(){layer.close(load)},success:function(html){layer.open({type:1,title:"图标库",content:html,area:["800px","700px"],maxmin:!0,shade:0,skin:"fiy-layer",success:function(layero,index){$(document).on("click",".icon-ku li",function(){$("a[fiy-id=show-icon]").find("i").attr("class",$(this).find("i").attr("class")),$("a[fiy-id=show-icon]").parent().prev().find("input").val($(this).find("i").attr("class")),layer.close(index)})}})}})}),$(document).on("click","[fiy-id=search-box-tag]",function(){$("[fiy-id=search-box]").slideToggle()}),$(document).on("mouseover","[fiy-tips]",function(){let th=$(this),index=layer.tips(th.attr("fiy-tips"),th,{tips:th.attr("fiy-tips-area")||1,time:0});th.on("mouseout",function(){layer.close(index)})}),$(document).on("click",".layui-logo",function(){location.reload()}),$(document).on("click",'[fiy-file-selected="file-net-path"]',function(){let th=$(this);$('input[file-select="file-net-path"]').val(th.attr("fiy-file-url"));let img=`<div class="img-box"><img src='${th.attr("fiy-file-url")}' fiy-photo />`;$("[fiy-photo-list]").html(img),layer.close(layer.index),Render_Viewer()}),$(document).on("click",'[fiy-file-selected="file-path"]',function(){let th=$(this),img;0==$('input[file-select="file-path"]').val().length?$('input[file-select="file-path"]').val(th.attr("fiy-file-path")):$('input[file-select="file-path"]').val($('input[file-select="file-path"]').val()+";"+th.attr("fiy-file-path")),img=th.attr("fiy-mime").indexOf("image")>-1?`<div class="img-box"><img src='${th.attr("fiy-file-url")}' fiy-photo />`:`<div class="img-box"><img src='/static/source/img/file.png' fiy-photo title='${th.attr("fiy-file-path")}' />`,$("[fiy-photo-list]").append(img),layer.close(layer.index),Render_Viewer()})});